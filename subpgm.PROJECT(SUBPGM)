000100 IDENTIFICATION DIVISION.
000200 PROGRAM-ID. SUBPGM.
000300 AUTHOR. COGNIZANT
000400 DATE-WRITTEN. 22-APR-2021
000500*----------------------------------------------------------
000600*
000700 ENVIRONMENT DIVISION.
000800 CONFIGURATION SECTION.
000900 INPUT-OUTPUT SECTION.
001000 FILE-CONTROL.
003306 DATA DIVISION.
003307 FILE SECTION.
003702 WORKING-STORAGE SECTION.
003707      EXEC SQL
003708         INCLUDE SQLCA
003709      END-EXEC.
003710*
003711      EXEC SQL
003712         INCLUDE DB32P197
003713      END-EXEC.
003714
008100*CURSOR DECLARATION
008200     EXEC SQL
008300         DECLARE C1 CURSOR FOR
008400         SELECT
008401              APPLICANT_ID,
008402              PREVIOUS_BAL_AMT,
008403              CURRENT_BAL_AMT,
008404              AMMOUNT_PAID
008405         FROM PAYMENT_DB
008406     END-EXEC.
008407*----------------------------------------------------------------*
008408*  SQL CODE VARIABLES
008409*----------------------------------------------------------------*
008410 01 WS-DB2-ERR-MSG.
008411    05 WS-DB2-ERR-MSG-LEN            PIC S9(4) COMP VALUE +560.
008412    05 WS-DB2-ERR-MSG-TEXT          PIC X(80)
008413                          OCCURS 07 TIMES INDEXED BY WS-INX.
008414 01 WS-DB2-ERRMSG-LINE-LEN           PIC S9(9) COMP VALUE +80.
008415*
008416 01 WW-SQLCODE-DEF.
008417     05 WW-SQLCODE-CODE                  PIC S9(3)
008418                                            SIGN LEADING SEPARATE.
008419     05 WW-SQL-ERR-CODE                 PIC  S9(3)
008500                                            SIGN LEADING SEPARATE.
008600           88 WW-END-OF-TABLE              VALUE +100.
008700           88 WW-SQL-OPERATION-SUCCESS     VALUE +000.
008701******************************************************************
008702*    ACCUMULATOR VARIABLE DECLARATION
008703******************************************************************
008704 01 WA-ACCUMULATOR.
008705     05 WA-FETCH-COUNT                  PIC S9(9) COMP VALUE 0.
008706     05 WA-UPDATE-COUNT                  PIC S9(9) COMP VALUE 0.
008800*
008811 PROCEDURE DIVISION.
008812 0000-MAIN-PARA.
013700     PERFORM 1000-INITIALIZE-PARA
013800        THRU 1000-INITIALIZE-PARA-EXIT.
013900
014000     PERFORM 2000-PROCESS-PARA
014100        THRU 2000-PROCESS-PARA-EXIT.
014200
014300     PERFORM 4000-CLOSE-PARA
014400        THRU 4000-CLOSE-PARA-EXIT.
014500
022800           PERFORM 5000-DISPLAY-PARA THRU
022900                   5000-DISPLAY-PARA-EXIT.
022901
022902     PERFORM 9100-TERMINATION-PARA
022903        THRU 9100-TERMINATION-PARA-EXIT.
022904        STOP RUN.
022905 0000-EXIT.
022906     EXIT.
022907*--------------------------------------------------------------*
022908 1000-INITIALIZE-PARA.
022909     INITIALIZE DCLPAYMENT-DB.
022910 1000-INITIALIZE-PARA-EXIT.
022911        EXIT.
022912*--------------------------------------------------------------*
022913 2000-PROCESS-PARA.
022914       PERFORM 2100-OPEN-CURSOR THRU
022915               2100-EXIT.
022916       PERFORM 2200-FETCH-CURSOR THRU
022917               2200-EXIT  UNTIL WW-END-OF-TABLE.
022918 2000-PROCESS-PARA-EXIT.
022919     EXIT.
022920*--------------------------------------------------------------*
022921 2100-OPEN-CURSOR.
022922      DISPLAY 'OPEN CUR PARA'
022923      EXEC SQL
022924          OPEN C1
022925      END-EXEC
022926      MOVE SQLCODE TO WW-SQL-ERR-CODE
022927      EVALUATE TRUE
022928      WHEN WW-SQL-OPERATION-SUCCESS
022929          DISPLAY 'CURSOR OPENED SUCCESS'
022930      WHEN OTHER
022931         DISPLAY 'CURSOR OPENED FAIL'
022932         DISPLAY WW-SQL-ERR-CODE
022933         PERFORM 9000-SQLERROR-PARA THRU 9000-EXIT
022934         PERFORM 9100-TERMINATION-PARA THRU
022935                    9100-TERMINATION-PARA-EXIT
022936      END-EVALUATE.
022937 2100-EXIT.
022938        EXIT.
022939*--------------------------------------------------------------*
022941 2200-FETCH-CURSOR.
022942     INITIALIZE DCLPAYMENT-DB
022943
022944            EXEC SQL
022950                 FETCH C1
022951                  INTO  :A-APPLICANT-ID,
022952                        :PREVIOUS-BAL-AMT,
022953                        :CURRENT-BAL-AMT,
022954                        :AMMOUNT-PAID
022955                  END-EXEC
022956        MOVE SQLCODE TO WW-SQL-ERR-CODE
022957        DISPLAY WW-SQL-ERR-CODE
022958        EVALUATE TRUE
022959        WHEN WW-SQL-OPERATION-SUCCESS
022960          DISPLAY 'DATA FETCH SUCCESS'
022961          ADD 1 TO WA-FETCH-COUNT
022962          PERFORM 3000-UPDATE-PARA   THRU 3000-EXIT
022963        WHEN WW-END-OF-TABLE
022964           PERFORM 4000-CLOSE-PARA THRU
022965                   4000-CLOSE-PARA-EXIT
022966           PERFORM 5000-DISPLAY-PARA THRU
022967                   5000-DISPLAY-PARA-EXIT
023000               PERFORM 9100-TERMINATION-PARA THRU
023100                       9100-TERMINATION-PARA-EXIT
023200        WHEN OTHER
023300               DISPLAY WW-SQL-ERR-CODE
023400               PERFORM 9000-SQLERROR-PARA THRU 9000-EXIT
023500               PERFORM 9100-TERMINATION-PARA THRU
023600                       9100-TERMINATION-PARA-EXIT
023700        END-EVALUATE.
023703 2200-EXIT.
023704      EXIT.
023705*--------------------------------------------------------------*
023706 3000-UPDATE-PARA.
023707*--------------------------------------------------------------*
023708*--------------PERFORMING THE CALCULATIONS OF------------------*
023709*--------CURRENT BALANCE AND PREVIOUS BALANCE------------------*
023710*--------------------------------------------------------------*
023711     MOVE CURRENT-BAL-AMT TO PREVIOUS-BAL-AMT
023712     COMPUTE CURRENT-BAL-AMT = CURRENT-BAL-AMT -
023713                               AMMOUNT-PAID
023714       EXEC SQL
023715       UPDATE PAYMENT_DB SET PREVIOUS_BAL_AMT =:PREVIOUS-BAL-AMT,
023720                  CURRENT_BAL_AMT =:CURRENT-BAL-AMT
023730          WHERE APPLICANT_ID =:A-APPLICANT-ID
023731       END-EXEC
023732        MOVE SQLCODE TO WW-SQL-ERR-CODE
023733        EVALUATE TRUE
023734        WHEN WW-SQL-OPERATION-SUCCESS
023735          DISPLAY 'DATA FETCH SUCCESS'
023736          ADD 1 TO WA-UPDATE-COUNT
023737        WHEN WW-END-OF-TABLE
023738        DISPLAY 'END OF TABLE'
023739        WHEN OTHER
023740               DISPLAY WW-SQL-ERR-CODE
023741               PERFORM 9000-SQLERROR-PARA THRU 9000-EXIT
023742               PERFORM 9100-TERMINATION-PARA THRU
023800                       9100-TERMINATION-PARA-EXIT
023900        END-EVALUATE.
024000 3000-EXIT.
024100     EXIT.
024200*--------------------------------------------------------------*
024300 4000-CLOSE-PARA.
036300       EXEC SQL
038100         CLOSE C1
038200        END-EXEC.
038210       MOVE SQLCODE TO WW-SQL-ERR-CODE
038300      EVALUATE TRUE
038400       WHEN WW-SQL-OPERATION-SUCCESS
038500         DISPLAY 'CURSOR CLOSED SUCCESSFULLY'
038602       WHEN OTHER
038603             DISPLAY WW-SQL-ERR-CODE
038604             PERFORM 9000-SQLERROR-PARA THRU 9000-EXIT
038605             PERFORM 9100-TERMINATION-PARA THRU
038606                     9100-TERMINATION-PARA-EXIT
038607        END-EVALUATE.
038608 4000-CLOSE-PARA-EXIT.
038609        EXIT.
038610******************************************************************03011006
038611* THIS PARA WILL DISPLAY THE SUMMARY OF REPORT                    03012006
038612******************************************************************03013006
038613 5000-DISPLAY-PARA.                                               03014006
038614     DISPLAY ' TOTAL FETCH COUNT  :' WA-FETCH-COUNT.              03018006
038615     DISPLAY ' TOTAL UPDATE COUNT :' WA-UPDATE-COUNT.             03018206
038616 5000-DISPLAY-PARA-EXIT.                                          03019906
038617     EXIT.                                                        03020206
038618*--------------------------------------------------------------*
038619 9000-SQLERROR-PARA.
038620      CALL 'DSNTIAR' USING  SQLCA , WS-DB2-ERR-MSG,
038621                                 WS-DB2-ERRMSG-LINE-LEN.
038622            IF RETURN-CODE = 0
038623                PERFORM VARYING WS-INX FROM 1 BY 1
038624                                      UNTIL WS-INX > 7
038625                DISPLAY WS-DB2-ERR-MSG-TEXT(WS-INX)
038626            END-PERFORM
038627            END-IF.
038628 9000-EXIT.
038629        EXIT.
038630*--------------------------------------------------------------*
038631 9100-TERMINATION-PARA.
038632        STOP RUN.
038633 9100-TERMINATION-PARA-EXIT.
038634        EXIT.
